<Window x:Class="SentryX.MapEditorWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:SentryX"
        xmlns:gif="http://wpfanimatedgif.codeplex.com"
        Title="電子地圖編輯器" 
        Height="900" Width="1400"
        MinHeight="600" MinWidth="800"
        WindowStartupLocation="CenterScreen">

    <Window.Resources>
        <local:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 工具列 -->
        <ToolBar Grid.Row="0" Height="40">
            <!-- 地圖管理 -->
            <Button Name="LoadMapButton" 
                    Content="📁 載入地圖" 
                    Padding="10,5"
                    Click="LoadMapButton_Click"
                    ToolTip="載入地圖圖片檔案"/>

            <Button Name="ClearMapButton" 
                    Content="🗑️ 清除地圖" 
                    Padding="10,5"
                    Click="ClearMapButton_Click"
                    ToolTip="清除目前的地圖"
                    IsEnabled="False"/>

            <Separator/>

            <!-- 設備管理 -->
            <Button Name="AddDeviceButton" 
                    Content="📷 新增設備" 
                    Padding="10,5"
                    Click="AddDeviceButton_Click"
                    ToolTip="在地圖上新增設備標記"
                    IsEnabled="False"/>

            <Button Name="EditModeButton" 
                    Content="✏️ 編輯模式" 
                    Padding="10,5"
                    Click="EditModeButton_Click"
                    ToolTip="切換編輯/檢視模式"
                    IsEnabled="False"/>

            <Button Name="DeleteSelectedButton" 
                    Content="❌ 刪除選中" 
                    Padding="10,5"
                    Click="DeleteSelectedButton_Click"
                    ToolTip="刪除選中的設備標記"
                    IsEnabled="False"/>

            <Separator/>

            <!-- 縮放控制 -->
            <TextBlock Text="縮放:" VerticalAlignment="Center" Margin="5,0"/>
            <Button Name="ZoomInButton" 
                    Content="➕" 
                    Width="30" 
                    Click="ZoomInButton_Click"
                    ToolTip="放大"/>

            <TextBlock Name="ZoomLevelText" 
                       Text="100%" 
                       Width="50" 
                       TextAlignment="Center"
                       VerticalAlignment="Center"/>

            <Button Name="ZoomOutButton" 
                    Content="➖" 
                    Width="30" 
                    Click="ZoomOutButton_Click"
                    ToolTip="縮小"/>

            <Button Name="ZoomResetButton" 
                    Content="🔄" 
                    Width="30" 
                    Click="ZoomResetButton_Click"
                    ToolTip="重設縮放"/>

            <Separator/>

            <!-- 檔案操作 -->
            <Button Name="SaveMapButton" 
                    Content="💾 儲存配置" 
                    Padding="10,5"
                    Click="SaveMapButton_Click"
                    ToolTip="儲存地圖配置"
                    IsEnabled="False"/>

            <Button Name="LoadConfigButton" 
                    Content="📂 載入配置" 
                    Padding="10,5"
                    Click="LoadConfigButton_Click"
                    ToolTip="載入地圖配置"/>
        </ToolBar>

        <!-- 主要內容區 -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="250"/>
            </Grid.ColumnDefinitions>

            <!-- 左側：設備列表 -->
            <GroupBox Grid.Column="0" Header="可用設備" Margin="5">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <TextBox Name="DeviceSearchBox" 
                             Grid.Row="0"
                             Text="搜尋設備..." 
                             Foreground="Gray"
                             Margin="5"
                             GotFocus="SearchBox_GotFocus"
                             LostFocus="SearchBox_LostFocus"
                             TextChanged="SearchBox_TextChanged"/>

                    <ListBox Name="AvailableDevicesList" 
                             Grid.Row="1"
                             Margin="5"
                             MouseDoubleClick="AvailableDevicesList_MouseDoubleClick"
                             SelectionMode="Single">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border BorderThickness="1" 
                                        BorderBrush="LightGray" 
                                        CornerRadius="3" 
                                        Padding="5" 
                                        Margin="2">
                                    <StackPanel>
                                        <TextBlock Text="{Binding Name}" 
                                                   FontWeight="Bold"/>
                                        <TextBlock Text="{Binding IP}" 
                                                   FontSize="10" 
                                                   Foreground="Gray"/>
                                        <TextBlock FontSize="10">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsOnline}" Value="True">
                                                            <Setter Property="Text" Value="🟢 在線"/>
                                                            <Setter Property="Foreground" Value="Green"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding IsOnline}" Value="False">
                                                            <Setter Property="Text" Value="🔴 離線"/>
                                                            <Setter Property="Foreground" Value="Red"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </GroupBox>

            <!-- 中間：地圖顯示區 -->
            <GroupBox Grid.Column="1" Header="地圖區域" Margin="5">
                <ScrollViewer Name="MapScrollViewer" 
                              HorizontalScrollBarVisibility="Auto"
                              VerticalScrollBarVisibility="Auto"
                              Background="#F0F0F0">

                    <Grid Name="MapContainer"
                          MouseWheel="MapContainer_MouseWheel"
                          ClipToBounds="True">

                        <!-- 縮放變換 -->
                        <Grid.LayoutTransform>
                            <ScaleTransform x:Name="MapScaleTransform" 
                                            ScaleX="1" 
                                            ScaleY="1"/>
                        </Grid.LayoutTransform>

                        <!-- Canvas 用於放置地圖和設備圖標 -->
                        <Canvas Name="MapCanvas" 
                                Width="1000" 
                                Height="800"
                                AllowDrop="True"
                                Drop="MapCanvas_Drop"
                                DragOver="MapCanvas_DragOver"
                                MouseLeftButtonDown="MapCanvas_MouseLeftButtonDown"
                                MouseMove="MapCanvas_MouseMove"
                                MouseLeftButtonUp="MapCanvas_MouseLeftButtonUp"
                                MouseRightButtonDown="MapCanvas_MouseRightButtonDown">

                            <!-- 背景圖片 -->
                            <Image Name="MapImage" 
                                   Stretch="None"
                                   Canvas.Left="0"
                                   Canvas.Top="0"
                                   Panel.ZIndex="0"/>

                            <!-- 設備圖標將動態添加到這裡 (ZIndex=1) -->

                            <!-- ✅ 新增：視野繪製層 (ZIndex=2) -->
                            <!-- ✅ 視野繪製層 (ZIndex=2) - 不接收滑鼠事件 -->
                            <Canvas Name="FieldOfViewCanvas"
                                    Width="1000"
                                    Height="1000"
                                    Background="{x:Null}"
                                    IsHitTestVisible="False"
                                    Panel.ZIndex="2"
                                    Canvas.Left="0"
                                    Canvas.Top="0"/>

                            <!-- ✅ 視野控制點層 (ZIndex=3) -->
                            <Canvas Name="FieldOfViewHandlesCanvas"
                                    Width="1000"
                                    Height="1000"
                                    Panel.ZIndex="3"
                                    Canvas.Left="0"
                                    Canvas.Top="0"/>

                        </Canvas>
                    </Grid>
                </ScrollViewer>
            </GroupBox>

            <!-- 右側：圖層設計器和設備屬性調整 -->
            <GroupBox Grid.Column="2" Header="圖層設計器" Margin="5">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="5"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- 圖層列表 -->
                    <ListBox Name="LayersList" 
                 Grid.Row="0"
                 Margin="5"
                 SelectionMode="Single">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal">
                                    <CheckBox IsChecked="{Binding Visibility, Converter={StaticResource BoolToVisibilityConverter}, Mode=TwoWay}" 
                                  Content="{Binding Name}" 
                                  ToolTip="切換圖層可見性"/>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <!-- 分隔線 -->
                    <GridSplitter Grid.Row="1" Height="5" 
                     HorizontalAlignment="Stretch" 
                     Background="Gray"
                     ResizeBehavior="PreviousAndNext"/>

                    <!-- 設備屬性調整面板 -->
                    <GroupBox Grid.Row="2" Header="設備屬性調整" 
                  Margin="5" Padding="5"
                  MinHeight="200">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <StackPanel Name="DevicePropertiesPanel" IsEnabled="False">

                                <!-- 設備名稱顯示 -->
                                <TextBlock Text="選中設備:" FontWeight="Bold" Margin="0,0,0,2"/>
                                <TextBlock Name="SelectedDeviceNameText" 
                              Text="未選擇設備" 
                              Foreground="Gray"
                              Margin="0,0,0,8"
                              TextWrapping="Wrap"/>

                                <!-- 位置調整 (X, Y 並排) -->
                                <TextBlock Text="位置 (px):" FontWeight="Bold" Margin="0,5,0,2"/>
                                <Grid Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="5"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="X:" FontSize="10" Margin="0,0,0,2"/>
                                        <TextBox Name="DeviceXTextBox" 
                                    Text="0"
                                    TextChanged="DevicePositionTextBox_TextChanged"/>
                                    </StackPanel>

                                    <StackPanel Grid.Column="2">
                                        <TextBlock Text="Y:" FontSize="10" Margin="0,0,0,2"/>
                                        <TextBox Name="DeviceYTextBox" 
                                    Text="0"
                                    TextChanged="DevicePositionTextBox_TextChanged"/>
                                    </StackPanel>
                                </Grid>

                                <!-- 大小調整 (寬, 高 並排) -->
                                <TextBlock Text="大小 (px):" FontWeight="Bold" Margin="0,5,0,2"/>
                                <Grid Margin="0,0,0,8">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="5"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>

                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="寬:" FontSize="10" Margin="0,0,0,2"/>
                                        <TextBox Name="DeviceWidthTextBox" 
                                    Text="60"
                                    TextChanged="DeviceSizeTextBox_TextChanged"/>
                                    </StackPanel>

                                    <StackPanel Grid.Column="2">
                                        <TextBlock Text="高:" FontSize="10" Margin="0,0,0,2"/>
                                        <TextBox Name="DeviceHeightTextBox" 
                                    Text="60"
                                    TextChanged="DeviceSizeTextBox_TextChanged"/>
                                    </StackPanel>
                                </Grid>

                                <!-- 快速調整按鈕 -->
                                <WrapPanel Margin="0,0,0,8">
                                    <Button Content="重置 (60×60)" 
                               Margin="0,0,5,0" Padding="5,2"
                               Click="ResetSize_Click"
                               ToolTip="重置為預設大小"/>
                                    <Button Content="對齊網格" 
                               Padding="5,2"
                               Click="AlignToGrid_Click"
                               ToolTip="對齊到 10px 網格"/>
                                </WrapPanel>

                                <!-- ✅ 視野設置區域 -->
                                <Border Name="FieldOfViewSettingsPanel" 
                            BorderBrush="LightGray" 
                            BorderThickness="1" 
                            CornerRadius="3"
                            Padding="5"
                            Margin="0,5,0,0">
                                    <StackPanel>
                                        <CheckBox Name="ShowFieldOfViewCheckBox" 
                                      Content="顯示攝影機視野"
                                      FontWeight="Bold"
                                      Margin="0,0,0,8"
                                      Checked="ShowFieldOfViewCheckBox_Changed"
                                      Unchecked="ShowFieldOfViewCheckBox_Changed"/>

                                        <!-- 視野角度和距離 (並排) -->
                                        <Grid Margin="0,0,0,8">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="5"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>

                                            <StackPanel Grid.Column="0">
                                                <TextBlock Text="角度 (°):" FontSize="10" Margin="0,0,0,2"/>
                                                <TextBox Name="ViewAngleTextBox" 
                                            Text="90"
                                            TextChanged="ViewAngleTextBox_TextChanged"/>
                                            </StackPanel>

                                            <StackPanel Grid.Column="2">
                                                <TextBlock Text="距離 (px):" FontSize="10" Margin="0,0,0,2"/>
                                                <TextBox Name="ViewDistanceTextBox" 
                                            Text="100"
                                            TextChanged="ViewDistanceTextBox_TextChanged"/>
                                            </StackPanel>
                                        </Grid>

                                        <!-- 視野方向 -->
                                        <TextBlock Text="方向 (°):" FontSize="10" Margin="0,0,0,2"/>
                                        <TextBox Name="ViewDirectionTextBox" 
                                    Text="0" 
                                    Margin="0,0,0,5"
                                    TextChanged="ViewDirectionTextBox_TextChanged"/>
                                    </StackPanel>
                                </Border>

                            </StackPanel>
                        </ScrollViewer>
                    </GroupBox>
                </Grid>
            </GroupBox>
        </Grid>

        <!-- 狀態列 -->
        <StatusBar Grid.Row="2">
            <StatusBarItem>
                <TextBlock Name="StatusText" Text="就緒"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock Name="MapInfoText" Text="未載入地圖"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock Name="DeviceCountText" Text="設備數量: 0"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock Name="MousePositionText" Text="座標: 0, 0"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock Name="EditModeText" Text="檢視模式" FontWeight="Bold"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>